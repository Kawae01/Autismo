<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const menu = document.getElementById("menu");
const scoreDisplay = document.getElementById("score");

let box = 20;
let snake = [];
let food;
let obstacles = [];
let score = 0;
let d = "RIGHT"; // âœ… direÃ§Ã£o inicial
let game;
let playerName;
let snakeColor = "yellow"; // âœ… fallback mobile
let mode;
let particles = [];
let paused = false;
let rainbowHue = 0;

// ===== CANVAS =====
function resizeCanvas(){
  canvas.width = Math.floor(window.innerWidth / box) * box;
  canvas.height = Math.floor(window.innerHeight / box) * box;
}
resizeCanvas();
window.addEventListener("resize", resizeCanvas);

// ===== START =====
function startGame(){
  playerName = document.getElementById("playerName").value || "Jogador";
  snakeColor = document.getElementById("snakeColor")?.value || "yellow";
  mode = document.getElementById("gameMode").value;

  menu.style.display = "none";

  snake = [{ x: 10 * box, y: 10 * box }];
  score = 0;
  d = "RIGHT";
  particles = [];
  obstacles = [];

  generateFood();
  if(mode === "hardcore") generateObstacles();

  clearInterval(game);
  game = setInterval(draw, mode==="hardcore" ? 80 : 100);
}

// ===== FOOD =====
function generateFood(){
  let valid = false;
  while(!valid){
    food = {
      x: Math.floor(Math.random()*(canvas.width/box))*box,
      y: Math.floor(Math.random()*(canvas.height/box))*box
    };
    valid = !collision(food,snake) && !collision(food,obstacles);
  }
}

// ===== OBSTACLES =====
function generateObstacles(){
  for(let i=0;i<10;i++){
    obstacles.push({
      x: Math.floor(Math.random()*(canvas.width/box))*box,
      y: Math.floor(Math.random()*(canvas.height/box))*box
    });
  }
}

// ===== INPUT =====
document.addEventListener("keydown", e=>{
  if(e.key=="ArrowLeft" && d!="RIGHT") d="LEFT";
  if(e.key=="ArrowUp" && d!="DOWN") d="UP";
  if(e.key=="ArrowRight" && d!="LEFT") d="RIGHT";
  if(e.key=="ArrowDown" && d!="UP") d="DOWN";
  if(e.key=="p") paused = !paused;
});

// ===== TOUCH =====
let startX, startY;
canvas.addEventListener("touchstart", e=>{
  startX = e.touches[0].clientX;
  startY = e.touches[0].clientY;
},{passive:false});

canvas.addEventListener("touchend", e=>{
  let dx = e.changedTouches[0].clientX - startX;
  let dy = e.changedTouches[0].clientY - startY;

  if(Math.abs(dx) > Math.abs(dy)){
    if(dx > 0 && d!="LEFT") d="RIGHT";
    if(dx < 0 && d!="RIGHT") d="LEFT";
  } else {
    if(dy > 0 && d!="UP") d="DOWN";
    if(dy < 0 && d!="DOWN") d="UP";
  }
},{passive:false});

// ===== COLLISION =====
function collision(head,array){
  return array.some(p => p.x === head.x && p.y === head.y);
}

// ===== PARTICLES =====
function createParticles(x,y){
  for(let i=0;i<10;i++){
    particles.push({
      x:x+box/2,
      y:y+box/2,
      vx:(Math.random()-0.5)*4,
      vy:(Math.random()-0.5)*4,
      alpha:1
    });
  }
}

function drawParticles(){
  for(let i=particles.length-1;i>=0;i--){
    let p=particles[i];
    ctx.fillStyle=`rgba(255,255,0,${p.alpha})`;
    ctx.beginPath();
    ctx.arc(p.x,p.y,2,0,Math.PI*2);
    ctx.fill();
    p.x+=p.vx;
    p.y+=p.vy;
    p.alpha-=0.05;
    if(p.alpha<=0) particles.splice(i,1);
  }
}

// ===== RAINBOW =====
function updateRainbow(){
  rainbowHue = (rainbowHue + 2) % 360;
}
function getRainbowColor(i){
  return `hsl(${(rainbowHue+i*10)%360},100%,50%)`;
}

// ===== DRAW =====
function draw(){
  if(paused) return;

  // GRID
  for(let x=0;x<canvas.width;x+=box){
    for(let y=0;y<canvas.height;y+=box){
      ctx.fillStyle=((x/box+y/box)%2)?"#2e8b2e":"#267326";
      ctx.fillRect(x,y,box,box);
    }
  }

  // OBSTACLES
  if(mode==="hardcore"){
    ctx.fillStyle="brown";
    obstacles.forEach(o=>ctx.fillRect(o.x,o.y,box,box));
  }

  // SNAKE
  updateRainbow();
  snake.forEach((s,i)=>{
    ctx.fillStyle = snakeColor==="rainbow"
      ? getRainbowColor(i)
      : snakeColor;
    ctx.fillRect(s.x,s.y,box,box);
  });

  // FOOD
  ctx.fillStyle="red";
  ctx.fillRect(food.x,food.y,box,box);

  drawParticles();

  // MOVE
  let head = { ...snake[0] };
  if(d=="LEFT") head.x-=box;
  if(d=="RIGHT") head.x+=box;
  if(d=="UP") head.y-=box;
  if(d=="DOWN") head.y+=box;

  if(mode==="infinito"){
    head.x=(head.x+canvas.width)%canvas.width;
    head.y=(head.y+canvas.height)%canvas.height;
  }

  if(head.x===food.x && head.y===food.y){
    score++;
    createParticles(food.x,food.y);
    generateFood();
  } else snake.pop();

  if(
    (mode!=="infinito" &&
    (head.x<0||head.y<0||head.x>=canvas.width||head.y>=canvas.height)) ||
    collision(head,snake) ||
    (mode==="hardcore" && collision(head,obstacles))
  ) return gameOver();

  snake.unshift(head);

  scoreDisplay.innerText = `${playerName} | ${mode} | Score: ${score}`;
}

// ===== GAME OVER =====
function gameOver(){
  clearInterval(game);
  alert(`ðŸ’€ Game Over, ${playerName}! PontuaÃ§Ã£o: ${score}`);
  menu.style.display="block";
}
</script>
